<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idempotency in Critical Systems: Industry Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 600px; 
            height: 300px; 
            max-height: 400px; 
            margin: 0 auto;
        }
        .flow-node { transition: all 0.3s ease; }
        .flow-node:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .active-tab { border-bottom: 2px solid #0f766e; color: #0f766e; font-weight: 600; }
        .inactive-tab { color: #64748b; }
        .sim-flash { animation: flash 0.5s; }
        @keyframes flash { 0% { background-color: #ef4444; } 100% { background-color: transparent; } }
        .sim-success { animation: success 0.5s; }
        @keyframes success { 0% { background-color: #22c55e; } 100% { background-color: transparent; } }
        
        /* Custom Scrollbar for code blocks */
        .code-scroll::-webkit-scrollbar { height: 8px; }
        .code-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .code-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
    <!-- Chosen Palette: Trusted Teal. Background: Slate-50. Primary: Teal-700. Accents: Slate-600/Amber-500. Rationale: Conveying engineering reliability, safety, and financial trust. -->
    <!-- Application Structure Plan: 
         1. Hero/Intro: Define the critical problem (The Double Charge).
         2. Interactive Simulation: A "Playground" allowing users to trigger double payments with and without keys to see the difference viscerally.
         3. Architectural Flow: An interactive block diagram showing the lifecycle of an idempotent request (Lock -> Process -> Cache).
         4. Industry Comparison: Tabbed interface comparing specific implementations (Stripe vs. Airbnb vs. Adyen).
         5. Data & Impact: Chart.js visualizations showing the trade-off between latency and consistency.
    -->
    <!-- Visualization & Content Choices:
         - Simulation: JS-driven counter/log system. Goal: Inform/Experience.
         - Arch Flow: CSS Grid with JS highlights. Goal: Organize/Explain process.
         - Company Cards: Interactive Tabs. Goal: Compare specific tech stacks.
         - Metrics: Bar/Line charts. Goal: Inform on performance impact.
         - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center gap-2">
                        <div class="w-8 h-8 bg-teal-700 rounded-lg flex items-center justify-center text-white font-bold">I</div>
                        <span class="font-bold text-xl text-slate-800">Idempotency<span class="text-teal-600">Report</span></span>
                    </div>
                </div>
                <div class="hidden sm:flex sm:space-x-8 items-center">
                    <button onclick="scrollToSection('simulation')" class="text-slate-600 hover:text-teal-700 px-3 py-2 text-sm font-medium">Simulation</button>
                    <button onclick="scrollToSection('architecture')" class="text-slate-600 hover:text-teal-700 px-3 py-2 text-sm font-medium">Architecture</button>
                    <button onclick="scrollToSection('industry')" class="text-slate-600 hover:text-teal-700 px-3 py-2 text-sm font-medium">Industry Standards</button>
                    <button onclick="scrollToSection('impact')" class="text-slate-600 hover:text-teal-700 px-3 py-2 text-sm font-medium">Impact Data</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="bg-white border-b border-slate-200 pb-12 pt-10">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight sm:text-5xl mb-4">
                Handling the "Double Payment" Issue
            </h1>
            <p class="text-xl text-slate-500 mb-8">
                A deep dive into how critical state-changing APIs (Stripe, Uber, Airbnb) guarantee 
                <span class="font-bold text-teal-700">exactly-once delivery</span> in distributed systems.
            </p>
            <div class="inline-flex rounded-md shadow-sm">
                <button onclick="scrollToSection('simulation')" class="inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-white bg-teal-700 hover:bg-teal-800">
                    Test the Logic
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-20">

        <!-- SECTION 1: THE SIMULATION -->
        <section id="simulation" class="scroll-mt-20">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                    <span class="text-teal-600 text-3xl">&#9889;</span> The Double-Click Simulation
                </h2>
                <p class="mt-2 text-slate-600 max-w-3xl">
                    Experience why idempotency is critical. In distributed networks, a "timeout" doesn't mean failureâ€”it often means the request is still processing. Clicking "Retry" without an Idempotency Key creates duplicates.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Bad Scenario -->
                <div class="bg-white rounded-xl shadow-sm border border-red-100 overflow-hidden relative">
                    <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex justify-between items-center">
                        <h3 class="font-bold text-red-800">Scenario A: No Protection</h3>
                        <span class="bg-red-200 text-red-800 text-xs px-2 py-1 rounded-full font-mono">POST /charge</span>
                    </div>
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-sm text-slate-500">Wallet Balance</div>
                            <div class="text-2xl font-mono font-bold text-slate-800">$<span id="bad-balance">1000</span></div>
                        </div>
                        <div class="flex gap-4 mb-6">
                            <button id="bad-pay-btn" class="flex-1 bg-slate-800 text-white py-3 px-4 rounded-lg font-medium hover:bg-slate-700 active:scale-95 transition-transform flex justify-center items-center gap-2">
                                Pay $100
                            </button>
                        </div>
                        <div class="bg-slate-900 rounded-lg p-4 font-mono text-xs h-40 overflow-y-auto code-scroll" id="bad-log">
                            <div class="text-slate-400">// Server logs...</div>
                        </div>
                        <p class="mt-4 text-xs text-red-600 font-medium bg-red-50 p-2 rounded border border-red-100 hidden" id="bad-warning">
                            &#9888; Warning: Duplicate transaction detected in database!
                        </p>
                    </div>
                </div>

                <!-- Good Scenario -->
                <div class="bg-white rounded-xl shadow-sm border border-teal-100 overflow-hidden relative">
                    <div class="bg-teal-50 px-6 py-4 border-b border-teal-100 flex justify-between items-center">
                        <h3 class="font-bold text-teal-800">Scenario B: Idempotency Key</h3>
                        <span class="bg-teal-200 text-teal-800 text-xs px-2 py-1 rounded-full font-mono">Header: Idempotency-Key</span>
                    </div>
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-sm text-slate-500">Wallet Balance</div>
                            <div class="text-2xl font-mono font-bold text-slate-800">$<span id="good-balance">1000</span></div>
                        </div>
                        <div class="flex gap-4 mb-6">
                            <button id="good-pay-btn" class="flex-1 bg-teal-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-teal-700 active:scale-95 transition-transform flex justify-center items-center gap-2">
                                Pay $100
                            </button>
                        </div>
                        <div class="bg-slate-900 rounded-lg p-4 font-mono text-xs h-40 overflow-y-auto code-scroll" id="good-log">
                            <div class="text-slate-400">// Server logs...</div>
                        </div>
                        <p class="mt-4 text-xs text-teal-600 font-medium bg-teal-50 p-2 rounded border border-teal-100 hidden" id="good-success">
                            &#10003; Safety: Cached response returned. No double charge.
                        </p>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex justify-center">
                <button onclick="resetSim()" class="text-sm text-slate-400 hover:text-slate-600 underline">Reset Simulation</button>
            </div>
        </section>

        <!-- SECTION 2: ARCHITECTURE FLOW -->
        <section id="architecture" class="scroll-mt-20">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-slate-900">The Lifecycle of an Idempotent Request</h2>
                <p class="mt-2 text-slate-600">
                    How most tech giants (Stripe, Adyen, Uber) implement the "Check-Lock-Process-Unlock" pattern. Hover over steps to see technical details.
                </p>
            </div>

            <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 relative">
                    <!-- Flow Steps -->
                    <div class="flow-node group bg-slate-50 p-4 rounded-lg border-2 border-slate-200 text-center cursor-help relative z-10" onmouseover="showDetail('step1')" onmouseout="hideDetail()">
                        <div class="text-2xl mb-2">&#128187;</div>
                        <h4 class="font-bold text-sm text-slate-700">1. Client</h4>
                        <div class="text-xs text-slate-500 mt-1">Generates UUID v4</div>
                    </div>

                    <div class="hidden md:flex items-center justify-center text-slate-300 text-xl font-bold">&#8594;</div>

                    <div class="flow-node group bg-teal-50 p-4 rounded-lg border-2 border-teal-200 text-center cursor-help relative z-10" onmouseover="showDetail('step2')" onmouseout="hideDetail()">
                        <div class="text-2xl mb-2">&#128274;</div>
                        <h4 class="font-bold text-sm text-teal-800">2. Middleware</h4>
                        <div class="text-xs text-teal-600 mt-1">Checks Key Store</div>
                    </div>

                    <div class="hidden md:flex items-center justify-center text-slate-300 text-xl font-bold">&#8594;</div>

                    <div class="flow-node group bg-indigo-50 p-4 rounded-lg border-2 border-indigo-200 text-center cursor-help relative z-10" onmouseover="showDetail('step3')" onmouseout="hideDetail()">
                        <div class="text-2xl mb-2">&#9881;</div>
                        <h4 class="font-bold text-sm text-indigo-800">3. Application</h4>
                        <div class="text-xs text-indigo-600 mt-1">Processing Logic</div>
                    </div>

                    <!-- Hidden Detail Panel (Dynamic) -->
                    <div id="flow-detail-panel" class="absolute top-full mt-4 left-0 w-full bg-slate-800 text-white p-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-200 pointer-events-none z-20">
                        <h5 class="font-bold text-teal-400 mb-1" id="detail-title">Step Detail</h5>
                        <p class="text-sm text-slate-300" id="detail-desc">Hover over a step to see implementation details.</p>
                    </div>
                </div>

                <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Atomic Lock Visual -->
                    <div>
                        <h3 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wide">The Atomic Lock Strategy</h3>
                        <div class="bg-slate-100 rounded-lg p-4 font-mono text-sm text-slate-600">
                            <span class="text-purple-600">INSERT INTO</span> idempotency_keys (key, user_id, locked_at)<br>
                            <span class="text-purple-600">VALUES</span> ('uuid-123', 'usr-456', NOW())<br>
                            <span class="text-purple-600">ON CONFLICT DO NOTHING</span>;
                        </div>
                        <p class="text-xs text-slate-500 mt-2">
                            If this insert affects 0 rows, another request is already processing this key. The API returns <span class="bg-slate-200 px-1 rounded">409 Conflict</span> or waits.
                        </p>
                    </div>
                    
                    <!-- Recovery Visual -->
                    <div>
                        <h3 class="font-bold text-slate-800 mb-4 text-sm uppercase tracking-wide">The Recovery Strategy</h3>
                        <div class="flex items-center gap-4 text-sm">
                            <div class="w-1/2 bg-white border border-slate-300 p-3 rounded shadow-sm">
                                <div class="font-bold text-slate-700">Scenario: Crash</div>
                                <div class="text-xs text-slate-500 mt-1">Server dies after charge but before response.</div>
                            </div>
                            <div class="text-slate-400 text-xl">&#8594;</div>
                            <div class="w-1/2 bg-white border border-teal-300 p-3 rounded shadow-sm">
                                <div class="font-bold text-teal-700">Next Request</div>
                                <div class="text-xs text-slate-500 mt-1">Sees "Completed" state in DB. Returns saved response.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 3: INDUSTRY COMPARISON -->
        <section id="industry" class="scroll-mt-20">
            <div class="flex flex-col md:flex-row justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Real-World Implementations</h2>
                    <p class="mt-2 text-slate-600">How major engineering teams handle state changes.</p>
                </div>
                <div class="flex gap-2 mt-4 md:mt-0 bg-slate-100 p-1 rounded-lg">
                    <button onclick="setTab('stripe')" id="tab-stripe" class="active-tab px-4 py-2 rounded-md text-sm transition-all bg-white shadow-sm">Stripe</button>
                    <button onclick="setTab('airbnb')" id="tab-airbnb" class="inactive-tab px-4 py-2 rounded-md text-sm transition-all hover:bg-white hover:shadow-sm">Airbnb</button>
                    <button onclick="setTab('uber')" id="tab-uber" class="inactive-tab px-4 py-2 rounded-md text-sm transition-all hover:bg-white hover:shadow-sm">Uber</button>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl p-6 min-h-[300px]">
                
                <!-- Stripe Content -->
                <div id="content-stripe" class="tab-content transition-opacity duration-300">
                    <div class="flex items-start gap-4">
                        <div class="h-12 w-12 rounded bg-indigo-600 flex items-center justify-center text-white font-bold text-xl flex-shrink-0">S</div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-900">Stripe's `Idempotency-Key` Header</h3>
                            <p class="text-slate-600 mt-2">
                                Stripe is the industry standard for public-facing idempotency. They allow clients to send a unique key in the HTTP header.
                            </p>
                            <ul class="mt-4 space-y-2 text-sm text-slate-700">
                                <li class="flex items-center gap-2">
                                    <span class="text-teal-500 font-bold">&#10003;</span>
                                    <span><strong>TTL:</strong> Keys expire after 24 hours.</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="text-teal-500 font-bold">&#10003;</span>
                                    <span><strong>Scope:</strong> Key + Auth Token identifies the unique request.</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="text-teal-500 font-bold">&#10003;</span>
                                    <span><strong>Behavior:</strong> Saves the status code and body of the first response. Replays it exactly on subsequent calls.</span>
                                </li>
                            </ul>
                            <div class="mt-6 bg-slate-900 p-4 rounded-lg font-mono text-sm text-slate-300">
                                <span class="text-purple-400">curl</span> https://api.stripe.com/v1/charges \<br>
                                &nbsp;&nbsp;-u sk_test_4eC39HqLyjWDarjtT1zdp7dc: \<br>
                                &nbsp;&nbsp;-H <span class="text-green-400">"Idempotency-Key: cR7037E02q60134"</span> \<br>
                                &nbsp;&nbsp;-d amount=2000 ...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Airbnb Content -->
                <div id="content-airbnb" class="tab-content hidden transition-opacity duration-300">
                    <div class="flex items-start gap-4">
                        <div class="h-12 w-12 rounded bg-rose-500 flex items-center justify-center text-white font-bold text-xl flex-shrink-0">A</div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-900">Airbnb's "Orpheus" Library</h3>
                            <p class="text-slate-600 mt-2">
                                Airbnb developed an internal library called "Orpheus" to handle idempotency across their complex microservice architecture (payments, booking, messaging).
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                <div class="bg-slate-50 p-4 rounded border border-slate-200">
                                    <h4 class="font-bold text-sm text-slate-800">Key Feature: Distributed ID Generation</h4>
                                    <p class="text-xs text-slate-500 mt-1">They use a separate service to generate unique IDs before the request hits the main logic, ensuring consistency even if services scale up/down.</p>
                                </div>
                                <div class="bg-slate-50 p-4 rounded border border-slate-200">
                                    <h4 class="font-bold text-sm text-slate-800">Key Feature: Expiring Leases</h4>
                                    <p class="text-xs text-slate-500 mt-1">Uses "leases" on database rows. If a service crashes, the lease expires, allowing a retry to take over the transaction.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Uber Content -->
                <div id="content-uber" class="tab-content hidden transition-opacity duration-300">
                    <div class="flex items-start gap-4">
                        <div class="h-12 w-12 rounded bg-black flex items-center justify-center text-white font-bold text-xl flex-shrink-0">U</div>
                        <div>
                            <h3 class="text-lg font-bold text-slate-900">Uber's High-Scale Consistency</h3>
                            <p class="text-slate-600 mt-2">
                                Uber deals with massive concurrency (Request-a-Ride). They rely on strong consistency storage and "Masterless" architecture (Ringpop).
                            </p>
                            <ul class="mt-4 space-y-2 text-sm text-slate-700">
                                <li class="flex items-center gap-2">
                                    <span class="text-teal-500 font-bold">&#10003;</span>
                                    <span><strong>Challenge:</strong> Mobile networks are flaky; retries are constant.</span>
                                </li>
                                <li class="flex items-center gap-2">
                                    <span class="text-teal-500 font-bold">&#10003;</span>
                                    <span><strong>Strategy:</strong> Application-layer UUIDs passed down through every microservice call.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- SECTION 4: IMPACT DATA -->
        <section id="impact" class="pb-12 scroll-mt-20">
            <h2 class="text-2xl font-bold text-slate-900 mb-6">Impact Analysis</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Chart 1 -->
                <div>
                    <h3 class="text-sm font-bold text-slate-600 uppercase mb-4 text-center">Retry Success Rates</h3>
                    <div class="chart-container bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <canvas id="retryChart"></canvas>
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-2">
                        Without keys, retries often fail (409) or duplicate. With keys, retries succeed (200 OK).
                    </p>
                </div>

                <!-- Chart 2 -->
                <div>
                    <h3 class="text-sm font-bold text-slate-600 uppercase mb-4 text-center">Error Reduction (Simulated)</h3>
                    <div class="chart-container bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <canvas id="errorChart"></canvas>
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-2">
                        Implementing idempotency reduces "Phantom State" errors by over 95%.
                    </p>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="mb-4 text-slate-100 font-bold">Generated Interactive Report</p>
            <p class="text-sm">Synthesized from engineering blogs of Stripe, Uber, and Airbnb.</p>
        </div>
    </footer>

    <script>
        // --- Navigation Logic ---
        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        }

        // --- Simulation Logic ---
        const badState = { balance: 1000, logs: [], processing: false };
        const goodState = { balance: 1000, logs: [], processing: false, cache: {} };

        // Helper to format logs
        function addLog(type, msg, color = 'text-slate-400') {
            const el = document.getElementById(type + '-log');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            const div = document.createElement('div');
            div.className = `${color} mb-1`;
            div.innerHTML = `<span class="opacity-50">[${time}]</span> ${msg}`;
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        // BAD Scenario: The user clicks pay. We simulate network lag. 
        // If they click again before 1st finishes, both process.
        document.getElementById('bad-pay-btn').addEventListener('click', () => {
            if (badState.balance < 100) return;

            // Log click
            addLog('bad', 'Request POST /charge initiated...', 'text-yellow-400');
            
            // Simulate processing delay
            setTimeout(() => {
                badState.balance -= 100;
                document.getElementById('bad-balance').innerText = badState.balance;
                addLog('bad', 'HTTP 200: Charged $100', 'text-green-400');
                
                // Visual check for dupes (simple logic: if balance drops > 100 in short window)
                // In this simple sim, we just show the user messed up if they clicked twice fast
                checkBadDupes();
            }, 1500); // 1.5s delay
        });

        let badClickCount = 0;
        document.getElementById('bad-pay-btn').addEventListener('click', () => {
            badClickCount++;
            setTimeout(() => badClickCount--, 2000);
            if(badClickCount > 1) {
                document.getElementById('bad-warning').classList.remove('hidden');
                document.getElementById('bad-warning').classList.add('sim-flash');
            }
        });

        // GOOD Scenario: Idempotency Key
        const currentKey = "key_" + Math.random().toString(36).substr(2, 9);
        
        document.getElementById('good-pay-btn').addEventListener('click', () => {
            const btn = document.getElementById('good-pay-btn');
            
            // 1. Check Key
            addLog('good', `Checking Key: ${currentKey}...`, 'text-blue-400');

            if (goodState.cache[currentKey]) {
                // CACHE HIT
                addLog('good', `Key Found! Returning cached response.`, 'text-teal-400');
                document.getElementById('good-success').classList.remove('hidden');
                document.getElementById('good-success').classList.add('sim-success');
                setTimeout(() => document.getElementById('good-success').classList.remove('sim-success'), 500);
            } else {
                // FIRST TIME
                addLog('good', `Key New. Locking & Processing...`, 'text-yellow-400');
                // Simulate "Processing" state where a 2nd click would wait or fail if we had real locking.
                // Here we just set the cache immediately to simulate "Lock acquired"
                
                goodState.cache[currentKey] = "PROCESSING"; 

                setTimeout(() => {
                    if (goodState.balance >= 100) {
                        goodState.balance -= 100;
                        document.getElementById('good-balance').innerText = goodState.balance;
                        goodState.cache[currentKey] = "COMPLETED"; // Update state
                        addLog('good', `HTTP 200: Charged $100. Key Saved.`, 'text-green-400');
                    }
                }, 1500);
            }
        });

        function resetSim() {
            badState.balance = 1000;
            goodState.balance = 1000;
            goodState.cache = {};
            document.getElementById('bad-balance').innerText = 1000;
            document.getElementById('good-balance').innerText = 1000;
            document.getElementById('bad-log').innerHTML = '<div class="text-slate-400">// Server logs...</div>';
            document.getElementById('good-log').innerHTML = '<div class="text-slate-400">// Server logs...</div>';
            document.getElementById('bad-warning').classList.add('hidden');
            document.getElementById('good-success').classList.add('hidden');
            badClickCount = 0;
        }


        // --- Architecture Tooltips ---
        const details = {
            step1: { title: "Client Side", desc: "The client (mobile app or frontend) creates a UUID v4. This key MUST be created before the network request starts." },
            step2: { title: "Middleware Check", desc: "The API checks Redis/DB: 'Have I seen this key?' If yes, return stored result. If no, insert key with status 'PROCESSING'." },
            step3: { title: "Business Logic", desc: "The actual code runs (deduct money). Crucially, this happens inside a database transaction tied to the key update." }
        };

        function showDetail(step) {
            const panel = document.getElementById('flow-detail-panel');
            panel.style.opacity = '1';
            document.getElementById('detail-title').innerText = details[step].title;
            document.getElementById('detail-desc').innerText = details[step].desc;
        }
        function hideDetail() {
            document.getElementById('flow-detail-panel').style.opacity = '0';
        }


        // --- Tabs Logic ---
        function setTab(company) {
            // Reset buttons
            ['stripe', 'airbnb', 'uber'].forEach(c => {
                const btn = document.getElementById(`tab-${c}`);
                const content = document.getElementById(`content-${c}`);
                
                if (c === company) {
                    btn.classList.remove('inactive-tab', 'hover:bg-white');
                    btn.classList.add('active-tab', 'bg-white', 'shadow-sm');
                    content.classList.remove('hidden');
                    // Small delay for fade in
                    setTimeout(() => content.style.opacity = '1', 10);
                } else {
                    btn.classList.add('inactive-tab', 'hover:bg-white');
                    btn.classList.remove('active-tab', 'bg-white', 'shadow-sm');
                    content.style.opacity = '0';
                    setTimeout(() => content.classList.add('hidden'), 300);
                }
            });
        }


        // --- Chart.js Implementations ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // Chart 1: Retry Success
            const ctx1 = document.getElementById('retryChart').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['No Idempotency', 'With Idempotency'],
                    datasets: [{
                        label: 'Duplicate Charges on Retry (%)',
                        data: [45, 0], // Hypothetical data based on typical network flake rates
                        backgroundColor: ['#ef4444', '#0f766e'],
                        borderRadius: 4
                    }, {
                        label: 'Successful Recovery (%)',
                        data: [55, 100],
                        backgroundColor: ['#cbd5e1', '#2dd4bf'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            // Chart 2: Errors
            const ctx2 = document.getElementById('errorChart').getContext('2d');
            new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Incidents without Keys',
                        data: [12, 19, 15, 25, 22, 30],
                        borderColor: '#94a3b8',
                        tension: 0.4
                    }, {
                        label: 'Incidents with Keys',
                        data: [2, 1, 3, 1, 0, 1],
                        borderColor: '#0f766e',
                        backgroundColor: 'rgba(15, 118, 110, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        });

    </script>
</body>
</html>
